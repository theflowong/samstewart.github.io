<!DOCTYPE html>
<html>
<head>
<title>Three.js test diagram</title>
<style>
	body { margin: 0; }
	canvas { width: 100%; height: 100% }
</style>

<!-- GSL shaders -->

<!-- default shaders -->
<script type="x-shader/x-vertex" id="vertexShader">
	varying vec2 vUv;

	void main() {
		vUv = uv;
		gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
	}

</script>

<script type="x-shader/x-fragment" id="defaultShader">
	uniform sampler2D outputTexture;
	varying vec2 vUv;

	void main() {
		float pressureField = texture2D(outputTexture, vUv).x * 20000.0;;
		gl_FragColor = vec4(pressureField, 0, 0, 1.0);
	}
</script>

<!-- visualizations -->
<script type="x-shader/x-fragment" id="pressureFieldVisualization">
	uniform sampler2D outputTexture;
	varying vec2 vUv;

	void main() {
		float pressureField = texture2D(outputTexture, vUv).x * 20000.0;;
		gl_FragColor = vec4(pressureField, 0, 0, 1.0);
	}
</script>

<!-- velocity field visualization -->
<script type="x-shader/x-fragment" id="velocityFieldVisualization">
	uniform sampler2D velocityTexture;
	varying vec2 vUv;

	void main() {
		vec2 v = texture2D(velocityTexture, vUv).xy;

		v.xy *= .999; // cool the color a bit

		gl_FragColor = vec4(v, 0, 1);
	}
</script>

<!-- particle field visualization -->
<script type="x-shader/x-fragment" id="particleFieldVisualization">

</script>
<!-- computation steps. Used with GPUComputationRenderer so we use some built-in variables. -->
<script type="x-shader/x-fragment" id="stepParticles">

	void main() {
		vec2
	}
</script>

<script type="x-shader/x-fragment" id="divergenceShader">
	void main() {
		vec2 uv = gl_FragCoord.xy / resolution.xy;

		gl_FragColor = texture2D(divergenceTexture, uv);

	}
</script>

<script type="x-shader/x-fragment" id="pressureShader">

	// the grid size
	uniform float dx;

	void main() {
		vec2 uv = gl_FragCoord.xy / resolution.xy;

		// do one step of Jacobi iteration (assuming we CLAMP_TO_BOUNDARY) the texture coordinates.
		float left = texture2D(pressureTexture, uv - vec2(dx, 0)).x;
		float right = texture2D(pressureTexture, uv + vec2(dx, 0)).x;
		float top = texture2D(pressureTexture, uv + vec2(0, dx)).x;
		float bottom = texture2D(pressureTexture, uv - vec2(0, dx)).x;

		// since we are solving for a scalar field, we store everything in the first coordinate.
		float center = texture2D(divergenceTexture, uv).x;

		// stencil for solving pressure Poisson equation is given by
		// [1/4 1/4 1/4 1/4 -b_grid.dx()^2 / 4]

		// TODO: what is the correct sign on (dx)^2? Appears to be a positive sign and not a negative one?
		// Article online says it should be positive
		float computedPressure = .25 * (left + right + top + bottom  + (dx*dx) * center);

		gl_FragColor = vec4(computedPressure, 0, 0, 1.0);

	}
</script>

<!-- Copyright (c) 2010-2015 The MathJax Consortium -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="text/javascript" src="lib/three.js/build/three.js"></script>
<script type="text/javascript" src="lib/three.js/examples/js/controls/OrbitControls.js"></script>
<script type="text/javascript" src="lib/three.js/examples/js/GPUComputationRenderer.js"></script>

<script type="text/javascript" src="lib/jquery-3.1.0.min.js"></script>

<script type="text/javascript" src="js/TextureUtils.js"></script>
<script type="text/javascript" src="js/fluid/fluid.js"></script>
<script type="text/javascript" src="js/fluid/RenderTarget.js"></script>
<script type="text/javascript" src="js/utils.js"></script>
<script type="text/javascript" src="js/app.js"></script>
<script type="text/javascript" src="js/MainRenderScene.js"></script>
</head>
<body>

</body>
</html>
